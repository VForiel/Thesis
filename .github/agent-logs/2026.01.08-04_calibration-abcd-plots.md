# Agent Modification Log: Enhanced ABCD Plotting

**Date:** 2026.01.08  
**Session:** 04  
**Topic:** calibration-abcd-plots

## Summary
Enhanced the `calibrate_abcd` algorithm with improved plotting that tracks metric evolution and phase shifter convergence per step (not per loop), with visual distinction between normal ABCD loops and the final fine sweep.

## Changes

### Modified
- `src/phise/modules/calibration/abcd.py`
  - Changed tracking from per-loop metrics to per-step metrics (one step = one shifter ABCD optimization)
  - Added `metric_history`, `shifter_history`, `loop_boundaries`, `fine_sweep_start` tracking
  - **Plot 1 (Metric)**: Shows kernel-null-depth after each ABCD step
    - X-axis: steps (numbered 0, 1, 2, ..., total_steps)
    - Vertical dashed lines separate loops
    - Orange background highlights the fine sweep region
  - **Plot 2 (Shifter Phases)**: Shows phase evolution for each shifter per step
    - X-axis: same steps as metric plot
    - One line per shifter (colored, labeled)
    - Same loop boundaries and fine sweep highlighting
  - Updated return dict with new keys

### Testing
- `tmp/test_abcd_plots.py`: smoke test verifying shapes and step counts
  - For n_loops=1, n_shifters=14, n_final_samples=16:
    - Total steps = 14 + 14 = 28 ✓
    - loop_boundaries = [14] ✓
    - fine_sweep_start = 14 ✓

## Plot Features
- **No hardcoding**: Automatically scales to any number of shifters
- **Visual clarity**: Orange zone distinguishes fine sweep from ABCD loops
- **Loop markers**: Vertical dashed lines at loop boundaries
- **General design**: Works for any photonic chip architecture

## Notes
- Metric history now reflects per-step updates for clear step-by-step convergence visualization
- Fine sweep region clearly marked in both metric and phase plots
- Legends shown when n_shifters <= 8 for readability
