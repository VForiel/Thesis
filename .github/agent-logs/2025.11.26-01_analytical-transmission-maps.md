# Agent Modification Log: Analytical Transmission Maps

**Date:** 2025-11-26
**Topic:** Analytical Transmission Maps Implementation
**Status:** Completed

## Summary

Implemented the TODO from `numerical_simulation.ipynb` (cell 34) for "transmission map of analytical model". Added new methods to compute and visualize transmission maps using a simplified analytical model that expresses kernel nuller outputs directly as functions of input phases.

## Files Modified

1. **`src/phise/classes/context.py`**
   - Added `get_analytical_transmission_maps(N)` method
   - Added `plot_analytical_transmission_maps(N, return_plot)` method
   - Added `get_analytical_transmission_map_jit()` numba-jitted function
   - Fixed return type annotation for `get_transmission_map_jit`

2. **`numerical_simulation.ipynb`**
   - Updated cell 34 from TODO comment to: `ctx.plot_analytical_transmission_maps(N=100)`

3. **`tests/test_context.py`**
   - Added `test_get_analytical_transmission_maps_shapes()`
   - Added `test_analytical_transmission_maps_physical_coherence()`
   - Added `test_analytical_vs_numerical_correlation()`
   - Added `test_plot_analytical_transmission_maps_returns_bytes()`

## New Functions/Classes

### Context Methods

```python
def get_analytical_transmission_maps(self, N: int) -> tuple[np.ndarray[float], np.ndarray[float]]:
    """Generate analytical kernel nuller transmission maps."""
    
def plot_analytical_transmission_maps(self, N: int, return_plot: bool = False) -> None:
    """Plot the analytical transmission maps."""
```

### Numba-JIT Function

```python
@nb.njit()
def get_analytical_transmission_map_jit(N, p, λ, fov) -> tuple[np.ndarray[float], np.ndarray[float]]:
    """Generate analytical transmission maps using closed-form expressions."""
```

## Physics Background

The analytical model uses simplified closed-form expressions for the kernel nuller outputs:

1. **Bright output**: All inputs combined constructively
   - B = |ψ₁ + ψ₂ + ψ₃ + ψ₄|² / 28

2. **Kernel outputs**: Differences between paired dark outputs
   - K_n = |D_{2n-1}|² - |D_{2n}|²
   - Dark outputs combine inputs with fixed π/2 phase shifts from MMI combiners

The model assumes ideal phase relationships (0, π/2, π, 3π/2) and does not include manufacturing errors (σ) or injected phase shifts (φ).

## Validation Performed

1. **Unit tests**: All 24 tests pass
2. **Physical coherence**: 
   - Bright output is non-negative
   - Kernel outputs are antisymmetric (zero mean)
   - No NaN or infinite values
3. **Numerical correlation**: >99% correlation with numerical model when σ=0 and φ=0
4. **CodeQL**: No security alerts

## Notes

- The normalization factor (1/4 × 1/7) accounts for splitting among 4 telescopes and 7 outputs
- Rotation uses -θ sign convention, matching the existing numerical model
- Unit tests verify correlation between analytical and numerical models exceeds 0.99
